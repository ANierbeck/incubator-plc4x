<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Plc4XModbusProtocol.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PLC4J: Protocol: Modbus</a> &gt; <a href="index.source.html" class="el_package">org.apache.plc4x.java.modbus.netty</a> &gt; <span class="el_source">Plc4XModbusProtocol.java</span></div><h1>Plc4XModbusProtocol.java</h1><pre class="source lang-java linenums">/*
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
&quot;License&quot;); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
&quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
*/
package org.apache.plc4x.java.modbus.netty;

import com.digitalpetri.modbus.ModbusPdu;
import com.digitalpetri.modbus.codec.ModbusTcpPayload;
import com.digitalpetri.modbus.requests.*;
import com.digitalpetri.modbus.responses.*;
import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.MessageToMessageCodec;
import org.apache.plc4x.java.api.exceptions.PlcException;
import org.apache.plc4x.java.api.exceptions.PlcProtocolException;
import org.apache.plc4x.java.api.messages.*;
import org.apache.plc4x.java.api.messages.items.*;
import org.apache.plc4x.java.api.types.ResponseCode;
import org.apache.plc4x.java.modbus.model.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicInteger;

public class Plc4XModbusProtocol extends MessageToMessageCodec&lt;ModbusTcpPayload, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt;&gt; {

<span class="nc" id="L44">    private static final Logger LOGGER = LoggerFactory.getLogger(Plc4XModbusProtocol.class);</span>

<span class="nc" id="L46">    public final AtomicInteger transactionId = new AtomicInteger();</span>

<span class="nc" id="L48">    private final ConcurrentMap&lt;Short, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt;&gt; requestsMap = new ConcurrentHashMap&lt;&gt;();</span>

<span class="nc" id="L50">    public Plc4XModbusProtocol() {</span>
<span class="nc" id="L51">    }</span>

    @Override
    protected void encode(ChannelHandlerContext ctx, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws Exception {
<span class="nc" id="L55">        LOGGER.trace(&quot;(&lt;--OUT): {}, {}, {}&quot;, ctx, msg, out);</span>
        // Reset transactionId on overflow
<span class="nc" id="L57">        transactionId.compareAndSet(Short.MAX_VALUE + 1, 0);</span>
<span class="nc" id="L58">        PlcRequest request = msg.getRequest();</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (request instanceof PlcReadRequest) {</span>
<span class="nc" id="L60">            encodeReadRequest(msg, out);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">        } else if (request instanceof PlcWriteRequest) {</span>
<span class="nc" id="L62">            encodeWriteRequest(msg, out);</span>
        }
<span class="nc" id="L64">    }</span>

    private void encodeWriteRequest(PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws PlcException {
<span class="nc" id="L67">        PlcWriteRequest request = (PlcWriteRequest) msg.getRequest();</span>
        // TODO: support multiple requests
<span class="nc" id="L69">        WriteRequestItem&lt;?&gt; writeRequestItem = request.getRequestItem().get();</span>
        // TODO: check if we can map like this. Implication is that we can only work with int, short, byte and boolean
        // TODO: for higher datatypes float, double etc we might need to split the bytes into chunks
<span class="nc" id="L72">        int quantity = writeRequestItem.getSize();</span>
<span class="nc" id="L73">        short unitId = 0;</span>

<span class="nc" id="L75">        ModbusAddress address = (ModbusAddress) writeRequestItem.getAddress();</span>
        ModbusPdu modbusRequest;
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (address instanceof RegisterAddress) {</span>
<span class="nc" id="L78">            RegisterAddress registerAddress = (RegisterAddress) address;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (quantity &gt; 1) {</span>
                // TODO: ensure we have a least quantity * 2 = N bytes
<span class="nc" id="L81">                byte[] bytesToWrite = (byte[]) writeRequestItem.getValues().get(0);</span>
<span class="nc" id="L82">                modbusRequest = new WriteMultipleRegistersRequest(registerAddress.getAddress(), quantity, bytesToWrite);</span>
<span class="nc" id="L83">            } else {</span>
<span class="nc" id="L84">                int intToWrite = (Integer) writeRequestItem.getValues().get(0);</span>
<span class="nc" id="L85">                modbusRequest = new WriteSingleRegisterRequest(registerAddress.getAddress(), intToWrite);</span>
            }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        } else if (address instanceof CoilAddress) {</span>
<span class="nc" id="L88">            CoilAddress coilAddress = (CoilAddress) address;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (quantity &gt; 1) {</span>
                // TODO: ensure we have a least (quantity + 7) / 8 = N bytes
<span class="nc" id="L91">                byte[] bytesToWrite = (byte[]) writeRequestItem.getValues().get(0);</span>
<span class="nc" id="L92">                modbusRequest = new WriteMultipleCoilsRequest(coilAddress.getAddress(), quantity, bytesToWrite);</span>
<span class="nc" id="L93">            } else {</span>
<span class="nc" id="L94">                boolean booleanToWrite = (Boolean) writeRequestItem.getValues().get(0);</span>
<span class="nc" id="L95">                modbusRequest = new WriteSingleCoilRequest(coilAddress.getAddress(), booleanToWrite);</span>
            }
<span class="nc" id="L97">        } else {</span>
<span class="nc" id="L98">            throw new PlcProtocolException(&quot;Unsupported address type&quot; + address.getClass());</span>
        }
<span class="nc" id="L100">        short transactionId = (short) this.transactionId.getAndIncrement();</span>
<span class="nc" id="L101">        requestsMap.put(transactionId, msg);</span>
<span class="nc" id="L102">        out.add(new ModbusTcpPayload(transactionId, unitId, modbusRequest));</span>
<span class="nc" id="L103">    }</span>

    private void encodeReadRequest(PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws PlcException {
<span class="nc" id="L106">        PlcReadRequest request = (PlcReadRequest) msg.getRequest();</span>
        // TODO: support multiple requests
<span class="nc" id="L108">        ReadRequestItem&lt;?&gt; readRequestItem = request.getRequestItem().get();</span>
        // TODO: check if we can map like this. Implication is that we can only work with int, short, byte and boolean
        // TODO: for higher datatypes float, double etc we might need to split the bytes into chunks
<span class="nc" id="L111">        int quantity = readRequestItem.getSize();</span>
        // TODO: the unit the should be used for multiple Requests
<span class="nc" id="L113">        short unitId = 0;</span>

<span class="nc" id="L115">        ModbusAddress address = (ModbusAddress) readRequestItem.getAddress();</span>
        ModbusPdu modbusRequest;
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (address instanceof CoilAddress) {</span>
<span class="nc" id="L118">            CoilAddress coilAddress = (CoilAddress) address;</span>
<span class="nc" id="L119">            modbusRequest = new ReadCoilsRequest(coilAddress.getAddress(), quantity);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        } else if (address instanceof RegisterAddress) {</span>
<span class="nc" id="L121">            RegisterAddress registerAddress = (RegisterAddress) address;</span>
<span class="nc" id="L122">            modbusRequest = new ReadHoldingRegistersRequest(registerAddress.getAddress(), quantity);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        } else if (address instanceof ReadDiscreteInputsModbusAddress) {</span>
<span class="nc" id="L124">            ReadDiscreteInputsModbusAddress readDiscreteInputsModbusAddress = (ReadDiscreteInputsModbusAddress) address;</span>
<span class="nc" id="L125">            modbusRequest = new ReadDiscreteInputsRequest(readDiscreteInputsModbusAddress.getAddress(), quantity);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        } else if (address instanceof ReadHoldingRegistersModbusAddress) {</span>
<span class="nc" id="L127">            ReadHoldingRegistersModbusAddress readHoldingRegistersModbusAddress = (ReadHoldingRegistersModbusAddress) address;</span>
<span class="nc" id="L128">            modbusRequest = new ReadHoldingRegistersRequest(readHoldingRegistersModbusAddress.getAddress(), quantity);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        } else if (address instanceof ReadInputRegistersModbusAddress) {</span>
<span class="nc" id="L130">            ReadInputRegistersModbusAddress readInputRegistersModbusAddress = (ReadInputRegistersModbusAddress) address;</span>
<span class="nc" id="L131">            modbusRequest = new ReadInputRegistersRequest(readInputRegistersModbusAddress.getAddress(), quantity);</span>
<span class="nc" id="L132">        } else {</span>
<span class="nc" id="L133">            throw new PlcProtocolException(&quot;Unsupported address type&quot; + address.getClass());</span>
        }
<span class="nc" id="L135">        short transactionId = (short) this.transactionId.getAndIncrement();</span>
<span class="nc" id="L136">        requestsMap.put(transactionId, msg);</span>
<span class="nc" id="L137">        out.add(new ModbusTcpPayload(transactionId, unitId, modbusRequest));</span>
<span class="nc" id="L138">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    protected void decode(ChannelHandlerContext ctx, ModbusTcpPayload msg, List&lt;Object&gt; out) throws Exception {
<span class="nc" id="L143">        LOGGER.trace(&quot;(--&gt;IN): {}, {}, {}&quot;, ctx, msg, out);</span>
<span class="nc" id="L144">        LOGGER.debug(&quot;{}: transactionId: {}, unitId: {}, modbusPdu:{}&quot;, msg, msg.getTransactionId(), msg.getUnitId(), msg.getModbusPdu());</span>
        // TODO: implement me
<span class="nc" id="L146">        short transactionId = msg.getTransactionId();</span>
<span class="nc" id="L147">        PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; plcRequestContainer = requestsMap.get(transactionId);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (plcRequestContainer == null) {</span>
<span class="nc" id="L149">            throw new PlcProtocolException(&quot;Unrelated payload received&quot; + msg);</span>
        }

        // TODO: only single Item supported for now
<span class="nc" id="L153">        PlcRequest request = plcRequestContainer.getRequest();</span>
<span class="nc" id="L154">        RequestItem requestItem = (RequestItem) request.getRequestItem().get();</span>

<span class="nc" id="L156">        ModbusPdu modbusPdu = msg.getModbusPdu();</span>
<span class="nc" id="L157">        short unitId = msg.getUnitId();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (modbusPdu instanceof WriteMultipleCoilsResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L161">            WriteMultipleCoilsResponse writeMultipleCoilsResponse = (WriteMultipleCoilsResponse) modbusPdu;</span>
<span class="nc" id="L162">            LOGGER.debug(&quot;{}: address:{}, quantity:{}&quot;, writeMultipleCoilsResponse, writeMultipleCoilsResponse.getAddress(), writeMultipleCoilsResponse.getQuantity());</span>
<span class="nc" id="L163">            plcRequestContainer.getResponseFuture().complete(new PlcWriteResponse((PlcWriteRequest) request, new WriteResponseItem&lt;&gt;((WriteRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK)));</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (modbusPdu instanceof WriteMultipleRegistersResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L166">            WriteMultipleRegistersResponse writeMultipleRegistersResponse = (WriteMultipleRegistersResponse) modbusPdu;</span>
<span class="nc" id="L167">            LOGGER.debug(&quot;{}: address:{}, quantity:{}&quot;, writeMultipleRegistersResponse, writeMultipleRegistersResponse.getAddress(), writeMultipleRegistersResponse.getQuantity());</span>
<span class="nc" id="L168">            plcRequestContainer.getResponseFuture().complete(new PlcWriteResponse((PlcWriteRequest) request, new WriteResponseItem&lt;&gt;((WriteRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK)));</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (modbusPdu instanceof WriteSingleCoilResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L171">            WriteSingleCoilResponse writeSingleCoilResponse = (WriteSingleCoilResponse) modbusPdu;</span>
<span class="nc" id="L172">            LOGGER.debug(&quot;{}: address:{}, value:{}&quot;, writeSingleCoilResponse, writeSingleCoilResponse.getAddress(), writeSingleCoilResponse.getValue());</span>
<span class="nc" id="L173">            plcRequestContainer.getResponseFuture().complete(new PlcWriteResponse((PlcWriteRequest) request, new WriteResponseItem&lt;&gt;((WriteRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK)));</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        } else if (modbusPdu instanceof WriteSingleRegisterResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L176">            WriteSingleRegisterResponse writeSingleRegisterResponse = (WriteSingleRegisterResponse) modbusPdu;</span>
<span class="nc" id="L177">            LOGGER.debug(&quot;{}: address:{}, value:{}&quot;, writeSingleRegisterResponse, writeSingleRegisterResponse.getAddress(), writeSingleRegisterResponse.getValue());</span>
<span class="nc" id="L178">            plcRequestContainer.getResponseFuture().complete(new PlcWriteResponse((PlcWriteRequest) request, new WriteResponseItem&lt;&gt;((WriteRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK)));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        } else if (modbusPdu instanceof ReadCoilsResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L181">            ReadCoilsResponse readCoilsResponse = (ReadCoilsResponse) modbusPdu;</span>
<span class="nc" id="L182">            LOGGER.debug(&quot;{}: Nothing&quot;, readCoilsResponse);</span>
<span class="nc" id="L183">            ByteBuf byteBuf = readCoilsResponse.getCoilStatus();</span>
<span class="nc" id="L184">            byte[] bytes = new byte[byteBuf.readableBytes()];</span>
<span class="nc" id="L185">            byteBuf.readBytes(bytes);</span>
<span class="nc" id="L186">            plcRequestContainer.getResponseFuture().complete(new PlcReadResponse((PlcReadRequest) request, new ReadResponseItem((ReadRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK, (Object) bytes)));</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        } else if (modbusPdu instanceof ReadDiscreteInputsResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L189">            ReadDiscreteInputsResponse readDiscreteInputsResponse = (ReadDiscreteInputsResponse) modbusPdu;</span>
<span class="nc" id="L190">            LOGGER.debug(&quot;{}: Nothing&quot;, readDiscreteInputsResponse);</span>
<span class="nc" id="L191">            ByteBuf byteBuf = readDiscreteInputsResponse.getInputStatus();</span>
<span class="nc" id="L192">            byte[] bytes = new byte[byteBuf.readableBytes()];</span>
<span class="nc" id="L193">            byteBuf.readBytes(bytes);</span>
<span class="nc" id="L194">            plcRequestContainer.getResponseFuture().complete(new PlcReadResponse((PlcReadRequest) request, new ReadResponseItem((ReadRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK, (Object) bytes)));</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        } else if (modbusPdu instanceof ReadHoldingRegistersResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L197">            ReadHoldingRegistersResponse readHoldingRegistersResponse = (ReadHoldingRegistersResponse) modbusPdu;</span>
<span class="nc" id="L198">            LOGGER.debug(&quot;{}: Nothing&quot;, readHoldingRegistersResponse);</span>
<span class="nc" id="L199">            ByteBuf byteBuf = readHoldingRegistersResponse.getRegisters();</span>
<span class="nc" id="L200">            byte[] bytes = new byte[byteBuf.readableBytes()];</span>
<span class="nc" id="L201">            byteBuf.readBytes(bytes);</span>
<span class="nc" id="L202">            plcRequestContainer.getResponseFuture().complete(new PlcReadResponse((PlcReadRequest) request, new ReadResponseItem((ReadRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK, (Object) bytes)));</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        } else if (modbusPdu instanceof ReadInputRegistersResponse) {</span>
            // TODO: finish implementation
<span class="nc" id="L205">            ReadInputRegistersResponse readInputRegistersResponse = (ReadInputRegistersResponse) modbusPdu;</span>
<span class="nc" id="L206">            LOGGER.debug(&quot;{}: Nothing&quot;, readInputRegistersResponse);</span>
<span class="nc" id="L207">            ByteBuf byteBuf = readInputRegistersResponse.getRegisters();</span>
<span class="nc" id="L208">            byte[] bytes = new byte[byteBuf.readableBytes()];</span>
<span class="nc" id="L209">            byteBuf.readBytes(bytes);</span>
<span class="nc" id="L210">            plcRequestContainer.getResponseFuture().complete(new PlcReadResponse((PlcReadRequest) request, new ReadResponseItem((ReadRequestItem&lt;? extends Object&gt;) requestItem, ResponseCode.OK, (Object) bytes)));</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        } else if (modbusPdu instanceof ExceptionResponse) {</span>
<span class="nc" id="L212">            ExceptionResponse exceptionResponse = (ExceptionResponse) modbusPdu;</span>
<span class="nc" id="L213">            throw new PlcProtocolException(&quot;Error received &quot; + exceptionResponse.getExceptionCode());</span>
        } else {
<span class="nc" id="L215">            throw new PlcProtocolException(&quot;Unsupported messageTyp type&quot; + modbusPdu.getClass());</span>
        }
<span class="nc" id="L217">    }</span>

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
<span class="nc" id="L221">        LOGGER.trace(&quot;(--&gt;ERR): {}&quot;, ctx, cause);</span>
<span class="nc" id="L222">        super.exceptionCaught(ctx, cause);</span>
<span class="nc" id="L223">    }</span>

    ////////////////////////////////////////////////////////////////////////////////
    // Encoding helpers.
    ////////////////////////////////////////////////////////////////////////////////


    ////////////////////////////////////////////////////////////////////////////////
    // Decoding helpers.
    ////////////////////////////////////////////////////////////////////////////////


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>