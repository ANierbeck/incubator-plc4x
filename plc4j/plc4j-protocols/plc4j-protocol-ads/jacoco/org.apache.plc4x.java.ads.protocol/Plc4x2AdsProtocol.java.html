<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Plc4x2AdsProtocol.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PLC4J: Protocol: ADS</a> &gt; <a href="index.source.html" class="el_package">org.apache.plc4x.java.ads.protocol</a> &gt; <span class="el_source">Plc4x2AdsProtocol.java</span></div><h1>Plc4x2AdsProtocol.java</h1><pre class="source lang-java linenums">/*
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 &quot;License&quot;); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
 */
package org.apache.plc4x.java.ads.protocol;

import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.MessageToMessageCodec;
import org.apache.plc4x.java.ads.api.commands.AdsReadRequest;
import org.apache.plc4x.java.ads.api.commands.AdsReadResponse;
import org.apache.plc4x.java.ads.api.commands.AdsWriteRequest;
import org.apache.plc4x.java.ads.api.commands.AdsWriteResponse;
import org.apache.plc4x.java.ads.api.commands.types.*;
import org.apache.plc4x.java.ads.api.generic.AmsPacket;
import org.apache.plc4x.java.ads.api.generic.types.AmsNetId;
import org.apache.plc4x.java.ads.api.generic.types.AmsPort;
import org.apache.plc4x.java.ads.api.generic.types.Invoke;
import org.apache.plc4x.java.ads.model.AdsAddress;
import org.apache.plc4x.java.api.exceptions.PlcException;
import org.apache.plc4x.java.api.exceptions.PlcIoException;
import org.apache.plc4x.java.api.exceptions.PlcProtocolException;
import org.apache.plc4x.java.api.messages.*;
import org.apache.plc4x.java.api.messages.items.ReadRequestItem;
import org.apache.plc4x.java.api.messages.items.ReadResponseItem;
import org.apache.plc4x.java.api.messages.items.WriteRequestItem;
import org.apache.plc4x.java.api.messages.items.WriteResponseItem;
import org.apache.plc4x.java.api.messages.specific.TypeSafePlcReadRequest;
import org.apache.plc4x.java.api.messages.specific.TypeSafePlcReadResponse;
import org.apache.plc4x.java.api.messages.specific.TypeSafePlcWriteRequest;
import org.apache.plc4x.java.api.messages.specific.TypeSafePlcWriteResponse;
import org.apache.plc4x.java.api.model.Address;
import org.apache.plc4x.java.api.types.ResponseCode;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicLong;

import static org.apache.plc4x.java.ads.protocol.util.LittleEndianDecoder.decodeData;
import static org.apache.plc4x.java.ads.protocol.util.LittleEndianEncoder.encodeData;

public class Plc4x2AdsProtocol extends MessageToMessageCodec&lt;AmsPacket, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt;&gt; {

<span class="fc" id="L62">    private static final Logger LOGGER = LoggerFactory.getLogger(Plc4x2AdsProtocol.class);</span>

<span class="fc" id="L64">    private static final AtomicLong correlationBuilder = new AtomicLong(1);</span>

    private final ConcurrentMap&lt;Long, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt;&gt; requests;

    private final AmsNetId targetAmsNetId;
    private final AmsPort targetAmsPort;
    private final AmsNetId sourceAmsNetId;
    private final AmsPort sourceAmsPort;

<span class="fc" id="L73">    public Plc4x2AdsProtocol(AmsNetId targetAmsNetId, AmsPort targetAmsPort, AmsNetId sourceAmsNetId, AmsPort sourceAmsPort) {</span>
<span class="fc" id="L74">        this.targetAmsNetId = targetAmsNetId;</span>
<span class="fc" id="L75">        this.targetAmsPort = targetAmsPort;</span>
<span class="fc" id="L76">        this.sourceAmsNetId = sourceAmsNetId;</span>
<span class="fc" id="L77">        this.sourceAmsPort = sourceAmsPort;</span>
<span class="fc" id="L78">        this.requests = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L79">    }</span>

    @Override
    protected void encode(ChannelHandlerContext ctx, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws Exception {
<span class="fc" id="L83">        PlcRequest request = msg.getRequest();</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (request instanceof PlcReadRequest) {</span>
<span class="fc" id="L85">            encodeReadRequest(msg, out);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        } else if (request instanceof PlcWriteRequest) {</span>
<span class="fc" id="L87">            encodeWriteRequest(msg, out);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        } else if (request instanceof PlcProprietaryRequest) {</span>
<span class="nc" id="L89">            encodeProprietaryRequest(msg, out);</span>
        } else {
<span class="nc" id="L91">            throw new PlcProtocolException(&quot;Unknown type &quot; + request.getClass());</span>
        }
<span class="fc" id="L93">    }</span>

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
<span class="nc bnc" id="L97" title="All 4 branches missed.">        if ((cause instanceof IOException) &amp;&amp; (cause.getMessage().contains(&quot;Connection reset by peer&quot;) ||</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            cause.getMessage().contains(&quot;Operation timed out&quot;))) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            String reason = cause.getMessage().contains(&quot;Connection reset by peer&quot;) ?</span>
                &quot;Connection terminated unexpectedly&quot; : &quot;Remote host not responding&quot;;
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (!requests.isEmpty()) {</span>
                // If the connection is hung up, all still pending requests can be closed.
<span class="nc bnc" id="L103" title="All 2 branches missed.">                for (PlcRequestContainer requestContainer : requests.values()) {</span>
<span class="nc" id="L104">                    requestContainer.getResponseFuture().completeExceptionally(new PlcIoException(reason));</span>
<span class="nc" id="L105">                }</span>
                // Clear the list
<span class="nc" id="L107">                requests.clear();</span>
            }
<span class="nc" id="L109">        } else {</span>
<span class="nc" id="L110">            super.exceptionCaught(ctx, cause);</span>
        }
<span class="nc" id="L112">    }</span>

    private void encodeWriteRequest(PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws PlcException {
<span class="fc" id="L115">        PlcWriteRequest writeRequest = (PlcWriteRequest) msg.getRequest();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (writeRequest.getRequestItems().size() != 1) {</span>
<span class="nc" id="L117">            throw new PlcProtocolException(&quot;Only one item supported&quot;);</span>
        }
<span class="fc" id="L119">        WriteRequestItem&lt;?&gt; writeRequestItem = writeRequest.getRequestItems().get(0);</span>
<span class="fc" id="L120">        Address address = writeRequestItem.getAddress();</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (!(address instanceof AdsAddress)) {</span>
<span class="nc" id="L122">            throw new PlcProtocolException(&quot;Address not of type AdsAddress: &quot; + address.getClass());</span>
        }
<span class="fc" id="L124">        AdsAddress adsAddress = (AdsAddress) address;</span>
<span class="fc" id="L125">        Invoke invokeId = Invoke.of(correlationBuilder.incrementAndGet());</span>
<span class="fc" id="L126">        IndexGroup indexGroup = IndexGroup.of(adsAddress.getIndexGroup());</span>
<span class="fc" id="L127">        IndexOffset indexOffset = IndexOffset.of(adsAddress.getIndexOffset());</span>
<span class="fc" id="L128">        byte[] bytes = encodeData(writeRequestItem.getDatatype(), writeRequestItem.getValues().toArray());</span>
<span class="fc" id="L129">        Data data = Data.of(bytes);</span>
<span class="fc" id="L130">        AmsPacket AmsPacket = AdsWriteRequest.of(targetAmsNetId, targetAmsPort, sourceAmsNetId, sourceAmsPort, invokeId, indexGroup, indexOffset, data);</span>
<span class="fc" id="L131">        out.add(AmsPacket);</span>
<span class="fc" id="L132">        requests.put(invokeId.getAsLong(), msg);</span>
<span class="fc" id="L133">    }</span>

    private void encodeReadRequest(PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws PlcException {
<span class="fc" id="L136">        PlcReadRequest readRequest = (PlcReadRequest) msg.getRequest();</span>

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (readRequest.getRequestItems().size() != 1) {</span>
<span class="nc" id="L139">            throw new PlcProtocolException(&quot;Only one item supported&quot;);</span>
        }
<span class="fc" id="L141">        ReadRequestItem&lt;?&gt; readRequestItem = readRequest.getRequestItems().get(0);</span>
<span class="fc" id="L142">        Address address = readRequestItem.getAddress();</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (!(address instanceof AdsAddress)) {</span>
<span class="nc" id="L144">            throw new PlcProtocolException(&quot;Address not of type AdsAddress: &quot; + address.getClass());</span>
        }
<span class="fc" id="L146">        AdsAddress adsAddress = (AdsAddress) address;</span>
<span class="fc" id="L147">        Invoke invokeId = Invoke.of(correlationBuilder.incrementAndGet());</span>
<span class="fc" id="L148">        IndexGroup indexGroup = IndexGroup.of(adsAddress.getIndexGroup());</span>
<span class="fc" id="L149">        IndexOffset indexOffset = IndexOffset.of(adsAddress.getIndexOffset());</span>
<span class="fc" id="L150">        Length length = Length.of(readRequestItem.getSize());</span>
<span class="fc" id="L151">        AmsPacket AmsPacket = AdsReadRequest.of(targetAmsNetId, targetAmsPort, sourceAmsNetId, sourceAmsPort, invokeId, indexGroup, indexOffset, length);</span>
<span class="fc" id="L152">        out.add(AmsPacket);</span>
<span class="fc" id="L153">        requests.put(invokeId.getAsLong(), msg);</span>
<span class="fc" id="L154">    }</span>

    private void encodeProprietaryRequest(PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; msg, List&lt;Object&gt; out) throws PlcProtocolException {
<span class="nc" id="L157">        PlcProprietaryRequest plcProprietaryRequest = (PlcProprietaryRequest) msg.getRequest();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!(plcProprietaryRequest.getRequest() instanceof AmsPacket)) {</span>
<span class="nc" id="L159">            throw new PlcProtocolException(&quot;Unsupported proprietary type for this driver &quot; + plcProprietaryRequest.getRequest().getClass());</span>
        }
<span class="nc" id="L161">        AmsPacket amsPacket = (AmsPacket) plcProprietaryRequest.getRequest();</span>
<span class="nc" id="L162">        requests.put(amsPacket.getAmsHeader().getInvokeId().getAsLong(), msg);</span>
<span class="nc" id="L163">        out.add(amsPacket);</span>
<span class="nc" id="L164">    }</span>

    @Override
    protected void decode(ChannelHandlerContext channelHandlerContext, AmsPacket amsPacket, List&lt;Object&gt; out) throws Exception {
<span class="fc" id="L168">        PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; plcRequestContainer = requests.remove(amsPacket.getAmsHeader().getInvokeId().getAsLong());</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (plcRequestContainer == null) {</span>
<span class="nc" id="L170">            LOGGER.info(&quot;Unmapped packet received {}&quot;, amsPacket);</span>
<span class="nc" id="L171">            return;</span>
        }
<span class="fc" id="L173">        PlcRequest request = plcRequestContainer.getRequest();</span>
<span class="fc" id="L174">        PlcResponse response = null;</span>

        // Handle the response to a read request.
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (request instanceof PlcReadRequest) {</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">            if (amsPacket instanceof AdsReadResponse) {</span>
<span class="fc" id="L179">                response = decodeReadResponse((AdsReadResponse) amsPacket, plcRequestContainer);</span>
            } else {
<span class="nc" id="L181">                throw new PlcProtocolException(&quot;Wrong type correlated &quot; + amsPacket);</span>
            }
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        } else if (request instanceof PlcWriteRequest) {</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (amsPacket instanceof AdsWriteResponse) {</span>
<span class="fc" id="L185">                response = decodeWriteResponse((AdsWriteResponse) amsPacket, plcRequestContainer);</span>
            } else {
<span class="nc" id="L187">                throw new PlcProtocolException(&quot;Wrong type correlated &quot; + amsPacket);</span>
            }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        } else if (request instanceof PlcProprietaryRequest) {</span>
<span class="nc" id="L190">            response = decodeProprietaryResponse(amsPacket, plcRequestContainer);</span>
        }

        // Confirm the response being handled.
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (response != null) {</span>
<span class="fc" id="L195">            plcRequestContainer.getResponseFuture().complete(response);</span>
        }
<span class="fc" id="L197">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private PlcResponse decodeWriteResponse(AdsWriteResponse responseMessage, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; requestContainer) {
<span class="fc" id="L201">        PlcWriteRequest plcWriteRequest = (PlcWriteRequest) requestContainer.getRequest();</span>
<span class="fc" id="L202">        WriteRequestItem requestItem = plcWriteRequest.getRequestItems().get(0);</span>

<span class="fc" id="L204">        ResponseCode responseCode = decodeResponseCode(responseMessage.getResult());</span>

<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (plcWriteRequest instanceof TypeSafePlcWriteRequest) {</span>
<span class="fc" id="L207">            return new TypeSafePlcWriteResponse((TypeSafePlcWriteRequest) plcWriteRequest, Collections.singletonList(new WriteResponseItem&lt;&gt;(requestItem, responseCode)));</span>
        } else {
<span class="nc" id="L209">            return new PlcWriteResponse(plcWriteRequest, Collections.singletonList(new WriteResponseItem&lt;&gt;(requestItem, responseCode)));</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private PlcResponse decodeReadResponse(AdsReadResponse responseMessage, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; requestContainer) throws PlcProtocolException {
<span class="fc" id="L215">        PlcReadRequest plcReadRequest = (PlcReadRequest) requestContainer.getRequest();</span>
<span class="fc" id="L216">        ReadRequestItem requestItem = plcReadRequest.getRequestItems().get(0);</span>

<span class="fc" id="L218">        ResponseCode responseCode = decodeResponseCode(responseMessage.getResult());</span>
<span class="fc" id="L219">        byte[] bytes = responseMessage.getData().getBytes();</span>
<span class="fc" id="L220">        List decoded = decodeData(requestItem.getDatatype(), bytes);</span>

<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (plcReadRequest instanceof TypeSafePlcReadRequest) {</span>
<span class="fc" id="L223">            return new TypeSafePlcReadResponse((TypeSafePlcReadRequest) plcReadRequest, Collections.singletonList(new ReadResponseItem&lt;&gt;(requestItem, responseCode, decoded)));</span>
        } else {
<span class="nc" id="L225">            return new PlcReadResponse(plcReadRequest, Collections.singletonList(new ReadResponseItem&lt;&gt;(requestItem, responseCode, decoded)));</span>
        }
    }

    private PlcResponse decodeProprietaryResponse(AmsPacket amsPacket, PlcRequestContainer&lt;PlcRequest, PlcResponse&gt; plcRequestContainer) {
<span class="nc" id="L230">        return new PlcProprietaryResponse&lt;&gt;((PlcProprietaryRequest) plcRequestContainer.getRequest(), amsPacket);</span>
    }

    private ResponseCode decodeResponseCode(Result result) {
<span class="pc bpc" id="L234" title="6 of 7 branches missed.">        switch (result.toAdsReturnCode()) {</span>
            case ADS_CODE_0:
<span class="fc" id="L236">                return ResponseCode.OK;</span>
            case ADS_CODE_1:
<span class="nc" id="L238">                return ResponseCode.INTERNAL_ERROR;</span>
            case ADS_CODE_2:
            case ADS_CODE_3:
            case ADS_CODE_4:
            case ADS_CODE_5:
<span class="nc" id="L243">                return ResponseCode.INTERNAL_ERROR;</span>
            case ADS_CODE_6:
            case ADS_CODE_7:
<span class="nc" id="L246">                return ResponseCode.INVALID_ADDRESS;</span>
            case ADS_CODE_8:
            case ADS_CODE_9:
            case ADS_CODE_10:
            case ADS_CODE_11:
            case ADS_CODE_12:
            case ADS_CODE_13:
            case ADS_CODE_14:
            case ADS_CODE_15:
            case ADS_CODE_16:
            case ADS_CODE_17:
            case ADS_CODE_18:
            case ADS_CODE_19:
            case ADS_CODE_20:
            case ADS_CODE_21:
            case ADS_CODE_22:
            case ADS_CODE_23:
            case ADS_CODE_24:
            case ADS_CODE_25:
            case ADS_CODE_26:
            case ADS_CODE_27:
            case ADS_CODE_28:
            case ADS_CODE_1280:
            case ADS_CODE_1281:
            case ADS_CODE_1282:
            case ADS_CODE_1283:
            case ADS_CODE_1284:
            case ADS_CODE_1285:
            case ADS_CODE_1286:
            case ADS_CODE_1287:
            case ADS_CODE_1288:
            case ADS_CODE_1289:
            case ADS_CODE_1290:
            case ADS_CODE_1291:
            case ADS_CODE_1292:
            case ADS_CODE_1293:
            case ADS_CODE_1792:
            case ADS_CODE_1793:
            case ADS_CODE_1794:
            case ADS_CODE_1795:
            case ADS_CODE_1796:
            case ADS_CODE_1797:
            case ADS_CODE_1798:
            case ADS_CODE_1799:
            case ADS_CODE_1800:
            case ADS_CODE_1801:
            case ADS_CODE_1802:
            case ADS_CODE_1803:
            case ADS_CODE_1804:
            case ADS_CODE_1805:
            case ADS_CODE_1806:
            case ADS_CODE_1807:
            case ADS_CODE_1808:
            case ADS_CODE_1809:
            case ADS_CODE_1810:
            case ADS_CODE_1811:
            case ADS_CODE_1812:
            case ADS_CODE_1813:
            case ADS_CODE_1814:
            case ADS_CODE_1815:
            case ADS_CODE_1816:
            case ADS_CODE_1817:
            case ADS_CODE_1818:
            case ADS_CODE_1819:
            case ADS_CODE_1820:
            case ADS_CODE_1821:
            case ADS_CODE_1822:
            case ADS_CODE_1823:
            case ADS_CODE_1824:
            case ADS_CODE_1825:
            case ADS_CODE_1826:
            case ADS_CODE_1827:
            case ADS_CODE_1828:
            case ADS_CODE_1836:
            case ADS_CODE_1856:
            case ADS_CODE_1857:
            case ADS_CODE_1858:
            case ADS_CODE_1859:
            case ADS_CODE_1860:
            case ADS_CODE_1861:
            case ADS_CODE_1862:
            case ADS_CODE_1863:
            case ADS_CODE_1864:
            case ADS_CODE_1872:
            case ADS_CODE_1873:
            case ADS_CODE_1874:
            case ADS_CODE_1875:
            case ADS_CODE_1876:
            case ADS_CODE_1877:
            case ADS_CODE_4096:
            case ADS_CODE_4097:
            case ADS_CODE_4098:
            case ADS_CODE_4099:
            case ADS_CODE_4100:
            case ADS_CODE_4101:
            case ADS_CODE_4102:
            case ADS_CODE_4103:
            case ADS_CODE_4104:
            case ADS_CODE_4105:
            case ADS_CODE_4106:
            case ADS_CODE_4107:
            case ADS_CODE_4108:
            case ADS_CODE_4109:
            case ADS_CODE_4110:
            case ADS_CODE_4111:
            case ADS_CODE_4112:
            case ADS_CODE_4119:
            case ADS_CODE_4120:
            case ADS_CODE_4121:
            case ADS_CODE_4122:
            case ADS_CODE_10060:
            case ADS_CODE_10061:
            case ADS_CODE_10065:
<span class="nc" id="L359">                return ResponseCode.INTERNAL_ERROR;</span>
            case UNKNOWN:
<span class="nc" id="L361">                return ResponseCode.INTERNAL_ERROR;</span>
        }
<span class="nc" id="L363">        throw new IllegalStateException(result.toAdsReturnCode() + &quot; not mapped&quot;);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>