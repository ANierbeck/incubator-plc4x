<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IsoTPProtocol.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PLC4J: Protocol: S7</a> &gt; <a href="index.source.html" class="el_package">org.apache.plc4x.java.isotp.netty</a> &gt; <span class="el_source">IsoTPProtocol.java</span></div><h1>IsoTPProtocol.java</h1><pre class="source lang-java linenums">/*
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
&quot;License&quot;); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
&quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
*/
package org.apache.plc4x.java.isotp.netty;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.ByteBufUtil;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.MessageToMessageCodec;
import org.apache.plc4x.java.isoontcp.netty.model.IsoOnTcpMessage;
import org.apache.plc4x.java.isotp.netty.model.IsoTPMessage;
import org.apache.plc4x.java.isotp.netty.model.params.*;
import org.apache.plc4x.java.isotp.netty.model.tpdus.*;
import org.apache.plc4x.java.isotp.netty.model.types.*;
import org.apache.plc4x.java.netty.events.S7ConnectionEvent;
import org.apache.plc4x.java.netty.events.S7ConnectionState;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

public class IsoTPProtocol extends MessageToMessageCodec&lt;IsoOnTcpMessage, Tpdu&gt; {

<span class="fc" id="L42">    private static final Logger logger = LoggerFactory.getLogger(IsoTPProtocol.class);</span>

    private final byte rackNo;
    private final byte slotNo;
    private final TpduSize tpduSize;

    private CalledTsapParameter calledTsapParameter;
    private TpduSizeParameter tpduSizeParameter;

<span class="fc" id="L51">    public IsoTPProtocol(byte rackNo, byte slotNo, TpduSize tpduSize) {</span>
<span class="fc" id="L52">        this.rackNo = rackNo;</span>
<span class="fc" id="L53">        this.slotNo = slotNo;</span>
<span class="fc" id="L54">        this.tpduSize = tpduSize;</span>
<span class="fc" id="L55">    }</span>

    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {
        // If the connection has just been established, start setting up the connection
        // by sending a connection request to the plc.
<span class="nc bnc" id="L61" title="All 4 branches missed.">        if(evt instanceof S7ConnectionEvent &amp;&amp; ((S7ConnectionEvent) evt).getState() == S7ConnectionState.INITIAL) {</span>
<span class="nc" id="L62">            logger.debug(&quot;ISO Transport Protocol Sending Connection Request&quot;);</span>
            // Open the session on ISO Transport Protocol first.
<span class="nc" id="L64">            ConnectionRequestTpdu connectionRequest = new ConnectionRequestTpdu(</span>
                (short) 0x0000, (short) 0x000F, ProtocolClass.CLASS_0,
<span class="nc" id="L66">                Arrays.asList(</span>
                    new CalledTsapParameter(DeviceGroup.PG_OR_PC, (byte) 0, (byte) 0),
                    new CallingTsapParameter(DeviceGroup.OTHERS, rackNo, slotNo),
                    new TpduSizeParameter(tpduSize)),
<span class="nc" id="L70">                Unpooled.buffer());</span>
<span class="nc" id="L71">            ctx.channel().writeAndFlush(connectionRequest);</span>
<span class="nc" id="L72">        } else {</span>
<span class="nc" id="L73">            super.userEventTriggered(ctx, evt);</span>
        }
<span class="nc" id="L75">    }</span>

    @Override
    protected void encode(ChannelHandlerContext ctx, Tpdu in, List&lt;Object&gt; out) throws Exception {
<span class="fc" id="L79">        logger.debug(&quot;ISO Transport Protocol Message sent&quot;);</span>
        
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (in == null) {</span>
<span class="fc" id="L82">            return;</span>
        }

<span class="fc" id="L85">        ByteBuf buf = Unpooled.buffer();</span>

        // Header length indicator field (The length byte doesn't count)
<span class="fc" id="L88">        buf.writeByte((byte) (getHeaderLength(in) - 1));</span>
        // TPDU Code (First 4 bits), Initial Credit Allocation (Second 4 bits)
<span class="fc" id="L90">        buf.writeByte(in.getTpduCode().getCode());</span>
        // The fixed header of a TCP TP Packet depends highly on the selected type.
<span class="pc bpc" id="L92" title="1 of 5 branches missed.">        switch (in.getTpduCode()) {</span>
            case CONNECTION_REQUEST:
            case CONNECTION_CONFIRM: {
<span class="fc" id="L95">                ConnectionTpdu connectionTpdu = (ConnectionTpdu) in;</span>
<span class="fc" id="L96">                buf.writeShort(connectionTpdu.getDestinationReference());</span>
<span class="fc" id="L97">                buf.writeShort(connectionTpdu.getSourceReference());</span>
<span class="fc" id="L98">                buf.writeByte(connectionTpdu.getProtocolClass().getCode());</span>
<span class="fc" id="L99">                outputParameters(buf, in.getParameters());</span>
<span class="fc" id="L100">                break;</span>
            }
            case DATA: {
<span class="fc" id="L103">                DataTpdu dataTpdu = (DataTpdu) in;</span>
                // EOT (Bit 8 = 1) / TPDU (All other bits 0)
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                buf.writeByte((byte) (dataTpdu.getTpduRef() | (dataTpdu.isEot() ? 0x80 : 0x00)));</span>
                // Note: A Data TPDU in Class 0 doesn't have parameters
<span class="fc" id="L107">                break;</span>
            }
            case DISCONNECT_REQUEST:
            case DISCONNECT_CONFIRM: {
<span class="fc" id="L111">                DisconnectTpdu disconnectTpdu = (DisconnectTpdu) in;</span>
<span class="fc" id="L112">                buf.writeShort(disconnectTpdu.getDestinationReference());</span>
<span class="fc" id="L113">                buf.writeShort(disconnectTpdu.getSourceReference());</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                if (disconnectTpdu instanceof DisconnectRequestTpdu) {</span>
<span class="fc" id="L115">                    DisconnectRequestTpdu disconnectRequestTpdu = (DisconnectRequestTpdu) disconnectTpdu;</span>
<span class="fc" id="L116">                    buf.writeByte(disconnectRequestTpdu.getDisconnectReason().getCode());</span>
                }
<span class="fc" id="L118">                outputParameters(buf, in.getParameters());</span>
<span class="fc" id="L119">                break;</span>
            }
            case TPDU_ERROR: {
<span class="fc" id="L122">                ErrorTpdu errorTpdu = (ErrorTpdu) in;</span>
<span class="fc" id="L123">                buf.writeShort(errorTpdu.getDestinationReference());</span>
<span class="fc" id="L124">                buf.writeByte(errorTpdu.getRejectCause().getCode());</span>
<span class="fc" id="L125">                outputParameters(buf, in.getParameters());</span>
<span class="fc" id="L126">                break;</span>
            }
            default: {
<span class="nc" id="L129">                logger.error(&quot;TDPU Value {} not implemented yet&quot;, new Object[]{in.getTpduCode().name()});</span>
<span class="nc" id="L130">                return;</span>
            }
        }
        // Add the user-data itself.
<span class="fc" id="L134">        buf.writeBytes(in.getUserData());</span>

<span class="fc" id="L136">        out.add(new IsoOnTcpMessage(buf));</span>
<span class="fc" id="L137">    }</span>

    @Override
    protected void decode(ChannelHandlerContext ctx, IsoOnTcpMessage in, List&lt;Object&gt; out) throws Exception {
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if(logger.isTraceEnabled()) {</span>
<span class="nc" id="L142">            logger.trace(&quot;Got Data: {}&quot;, ByteBufUtil.hexDump(in.getUserData()));</span>
        }
<span class="fc" id="L144">        logger.debug(&quot;ISO TP Message received&quot;);</span>

<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (in == null) {</span>
<span class="fc" id="L147">            return;</span>
        }

<span class="fc" id="L150">        ByteBuf userData = in.getUserData();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">        if (userData.writerIndex() &lt; 1) {</span>
<span class="fc" id="L152">            return;</span>
        }
        
<span class="fc" id="L155">        int packetStart = userData.readerIndex();</span>
<span class="fc" id="L156">        byte headerLength = userData.readByte();</span>
<span class="fc" id="L157">        int headerEnd = packetStart + headerLength;</span>
<span class="fc" id="L158">        TpduCode tpduCode = TpduCode.valueOf(userData.readByte());</span>
        // Read fixed header part.
<span class="fc" id="L160">        Tpdu tpdu = null;</span>
<span class="fc" id="L161">        List&lt;Parameter&gt; parameters = new LinkedList&lt;&gt;();</span>
<span class="pc bpc" id="L162" title="1 of 5 branches missed.">        switch (tpduCode) {</span>
            case CONNECTION_REQUEST:
            case CONNECTION_CONFIRM: {
<span class="fc" id="L165">                short destinationReference = userData.readShort();</span>
<span class="fc" id="L166">                short sourceReference = userData.readShort();</span>
<span class="fc" id="L167">                ProtocolClass protocolClass = ProtocolClass.valueOf(userData.readByte());</span>
<span class="pc bpc" id="L168" title="1 of 3 branches missed.">                switch (tpduCode) {</span>
                    case CONNECTION_REQUEST:
<span class="fc" id="L170">                        tpdu = new ConnectionRequestTpdu(destinationReference, sourceReference, protocolClass, parameters, userData);</span>
<span class="fc" id="L171">                        break;</span>
                    case CONNECTION_CONFIRM:
<span class="fc" id="L173">                        tpdu = new ConnectionConfirmTpdu(destinationReference, sourceReference, protocolClass, parameters, userData);</span>
<span class="fc" id="L174">                        ctx.channel().pipeline().fireUserEventTriggered(</span>
                            new S7ConnectionEvent(S7ConnectionState.ISO_TP_CONNECTION_RESPONSE_RECEIVED));
                        break;
                }
<span class="fc" id="L178">                break;</span>
            }
            case DATA: {
<span class="fc" id="L181">                byte tmp = userData.readByte();</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">                boolean eot = (tmp &amp; 0x80) == 0x80;</span>
<span class="fc" id="L183">                byte tpduRef = (byte) (tmp &amp; 0x7F);</span>
<span class="fc" id="L184">                tpdu = new DataTpdu(eot, tpduRef, parameters, userData);</span>
<span class="fc" id="L185">                break;</span>
            }
            case DISCONNECT_REQUEST:
            case DISCONNECT_CONFIRM: {
<span class="fc" id="L189">                short destinationReference = userData.readShort();</span>
<span class="fc" id="L190">                short sourceReference = userData.readShort();</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">                if (tpduCode == TpduCode.DISCONNECT_REQUEST) {</span>
<span class="fc" id="L192">                    DisconnectReason disconnectReason = DisconnectReason.valueOf(userData.readByte());</span>
<span class="fc" id="L193">                    tpdu = new DisconnectRequestTpdu(</span>
                        destinationReference, sourceReference, disconnectReason, parameters, userData);
<span class="fc" id="L195">                } else {</span>
<span class="fc" id="L196">                    tpdu = new DisconnectConfirmTpdu(</span>
                        destinationReference, sourceReference, parameters, userData);
                }
<span class="fc" id="L199">                break;</span>
            }
            case TPDU_ERROR: {
<span class="fc" id="L202">                short destinationReference = userData.readShort();</span>
<span class="fc" id="L203">                RejectCause rejectCause = RejectCause.valueOf(userData.readByte());</span>
<span class="fc" id="L204">                tpdu = new ErrorTpdu(destinationReference, rejectCause, parameters, userData);</span>
<span class="fc" id="L205">                break;</span>
            }
        }

        // Read variable header parameters
<span class="fc bfc" id="L210" title="All 2 branches covered.">        while (userData.readerIndex() &lt; headerEnd) {</span>
<span class="fc" id="L211">            Parameter parameter = parseParameter(userData);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (parameter != null) {</span>
<span class="nc" id="L213">                parameters.add(parameter);</span>
            }
<span class="fc" id="L215">        }</span>

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        if (tpdu != null) {</span>
            // If we got a ConnectionConfirmTpdu response we are currently
            // in the process of establishing a connection with the PLC, so
            // Save some of the information in the session and tell the next
            // layer to negotiate the connection parameters.
<span class="fc bfc" id="L222" title="All 2 branches covered.">            if (tpdu instanceof ConnectionConfirmTpdu) {</span>
<span class="fc" id="L223">                calledTsapParameter = tpdu.getParameter(CalledTsapParameter.class);</span>
<span class="fc" id="L224">                tpduSizeParameter = tpdu.getParameter(TpduSizeParameter.class);</span>
            }
<span class="fc" id="L226">            out.add(new IsoTPMessage(tpdu, userData));</span>
        }
<span class="fc" id="L228">    }</span>

    private void outputParameters(ByteBuf out, List&lt;Parameter&gt; parameters) {
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (parameters != null) {</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">            for (Parameter parameter : parameters) {</span>
<span class="nc" id="L233">                out.writeByte(parameter.getType().getCode());</span>
<span class="nc" id="L234">                out.writeByte((byte) (getParameterLength(parameter) - 2));</span>
<span class="pc bnc" id="L235" title="All 5 branches missed.">                switch (parameter.getType()) {</span>
                    case CALLED_TSAP:
                    case CALLING_TSAP: {
<span class="nc" id="L238">                        TsapParameter tsap = (TsapParameter) parameter;</span>
<span class="nc" id="L239">                        out.writeByte(tsap.getDeviceGroup().getCode());</span>
<span class="nc" id="L240">                        out.writeByte((byte)</span>
<span class="nc" id="L241">                            ((tsap.getRackNumber() &lt;&lt; 4) | (tsap.getSlotNumber())));</span>
<span class="nc" id="L242">                        break;</span>
                    }
                    case CHECKSUM: {
<span class="nc" id="L245">                        ChecksumParameter checksum = (ChecksumParameter) parameter;</span>
<span class="nc" id="L246">                        out.writeByte(checksum.getChecksum());</span>
<span class="nc" id="L247">                        break;</span>
                    }
                    case DISCONNECT_ADDITIONAL_INFORMATION: {
<span class="nc" id="L250">                        DisconnectAdditionalInformationParameter disconnectAdditionalInformation = (DisconnectAdditionalInformationParameter) parameter;</span>
<span class="nc" id="L251">                        out.writeBytes(disconnectAdditionalInformation.getData());</span>
<span class="nc" id="L252">                        break;</span>
                    }
                    case TPDU_SIZE: {
<span class="nc" id="L255">                        TpduSizeParameter tpduSize = (TpduSizeParameter) parameter;</span>
<span class="nc" id="L256">                        out.writeByte(tpduSize.getTpduSize().getCode());</span>
<span class="nc" id="L257">                        break;</span>
                    }
                    default: {
<span class="nc" id="L260">                        logger.error(&quot;TDPU tarameter type {} not implemented yet&quot;,</span>
<span class="nc" id="L261">                            new Object[]{parameter.getType().name()});</span>
<span class="nc" id="L262">                        return;</span>
                    }
                }
<span class="nc" id="L265">            }</span>
        }
<span class="fc" id="L267">    }</span>

    /**
     * Return the length of the entire header in bytes (including the size field itself)
     * This is a sum of the fixed size header defined for the given tpdu type and the
     * lengths of all parameters.
     *
     * @param tpdu Tpdu to get the header length for
     * @return length of the iso tp header
     */
    private short getHeaderLength(Tpdu tpdu) {
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (tpdu != null) {</span>
<span class="fc" id="L279">            short headerLength = 0;</span>
<span class="pc bpc" id="L280" title="1 of 6 branches missed.">            switch (tpdu.getTpduCode()) {</span>
                case CONNECTION_REQUEST:
                case CONNECTION_CONFIRM:
<span class="fc" id="L283">                    headerLength = 7;</span>
<span class="fc" id="L284">                    break;</span>
                case DATA:
<span class="fc" id="L286">                    headerLength = 3;</span>
<span class="fc" id="L287">                    break;</span>
                case DISCONNECT_REQUEST:
<span class="fc" id="L289">                    headerLength = 7;</span>
<span class="fc" id="L290">                    break;</span>
                case DISCONNECT_CONFIRM:
<span class="fc" id="L292">                    headerLength = 6;</span>
<span class="fc" id="L293">                    break;</span>
                case TPDU_ERROR:
<span class="fc" id="L295">                    headerLength = 5;</span>
                    break;
            }
<span class="fc" id="L298">            return (short) (headerLength + getParametersLength(tpdu.getParameters()));</span>
        }
<span class="nc" id="L300">        return 0;</span>
    }

    private short getParametersLength(List&lt;Parameter&gt; parameters) {
<span class="fc" id="L304">        short length = 0;</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">        if (parameters != null) {</span>
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">            for (Parameter parameter : parameters) {</span>
<span class="nc" id="L307">                length += getParameterLength(parameter);</span>
<span class="nc" id="L308">            }</span>
        }
<span class="fc" id="L310">        return length;</span>
    }

    private short getParameterLength(Parameter parameter) {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (parameter != null) {</span>
<span class="nc bnc" id="L315" title="All 5 branches missed.">            switch (parameter.getType()) {</span>
                case CALLED_TSAP:
                case CALLING_TSAP:
<span class="nc" id="L318">                    return 4;</span>
                case CHECKSUM:
<span class="nc" id="L320">                    return 3;</span>
                case DISCONNECT_ADDITIONAL_INFORMATION: {
<span class="nc" id="L322">                    DisconnectAdditionalInformationParameter disconnectAdditionalInformationParameter =</span>
                        (DisconnectAdditionalInformationParameter) parameter;
<span class="nc bnc" id="L324" title="All 2 branches missed.">                    return (short) (2 + ((disconnectAdditionalInformationParameter.getData() != null) ?</span>
<span class="nc" id="L325">                        disconnectAdditionalInformationParameter.getData().length : 0));</span>
                }
                case TPDU_SIZE:
<span class="nc" id="L328">                    return 3;</span>
            }
        }
<span class="nc" id="L331">        return 0;</span>
    }

    private Parameter parseParameter(ByteBuf out) {
<span class="fc" id="L335">        ParameterCode parameterCode = ParameterCode.valueOf(out.readByte());</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (parameterCode == null) {</span>
<span class="fc" id="L337">            logger.error(&quot;Could not find parameter code&quot;);</span>
<span class="fc" id="L338">            return null;</span>
        }
<span class="nc" id="L340">        byte length = out.readByte();</span>
<span class="nc bnc" id="L341" title="All 5 branches missed.">        switch (parameterCode) {</span>
            case CALLING_TSAP:
            case CALLED_TSAP: {
<span class="nc" id="L344">                DeviceGroup deviceGroup = DeviceGroup.valueOf(out.readByte());</span>
<span class="nc" id="L345">                byte tmp = out.readByte();</span>
<span class="nc" id="L346">                byte rackId = (byte) ((tmp &amp; 0xF0) &gt;&gt; 4);</span>
<span class="nc" id="L347">                byte slotId = (byte) (tmp &amp; 0x0F);</span>
<span class="nc bnc" id="L348" title="All 3 branches missed.">                switch (parameterCode) {</span>
                    case CALLING_TSAP:
<span class="nc" id="L350">                        return new CallingTsapParameter(deviceGroup, rackId, slotId);</span>
                    case CALLED_TSAP:
<span class="nc" id="L352">                        return new CalledTsapParameter(deviceGroup, rackId, slotId);</span>
                    default:
<span class="nc" id="L354">                        logger.error(&quot;Parameter not implemented yet &quot; + parameterCode.name());</span>
<span class="nc" id="L355">                        return null;</span>
                }
            }
            case CHECKSUM: {
<span class="nc" id="L359">                byte checksum = out.readByte();</span>
<span class="nc" id="L360">                return new ChecksumParameter(checksum);</span>
            }
            case DISCONNECT_ADDITIONAL_INFORMATION: {
<span class="nc" id="L363">                byte[] data = new byte[length];</span>
<span class="nc" id="L364">                out.readBytes(data);</span>
<span class="nc" id="L365">                return new DisconnectAdditionalInformationParameter(data);</span>
            }
            case TPDU_SIZE: {
<span class="nc" id="L368">                TpduSize tpduSize = TpduSize.valueOf(out.readByte());</span>
<span class="nc" id="L369">                return new TpduSizeParameter(tpduSize);</span>
            }
            default: {
<span class="nc" id="L372">                logger.error(&quot;Parameter not implemented yet &quot; + parameterCode.name());</span>
<span class="nc" id="L373">                return null;</span>
            }
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>